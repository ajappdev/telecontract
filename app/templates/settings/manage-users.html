{% extends "base.html" %}
{% load static %}
{% block page_content %}
{% load i18n %}
{% load humanize %}

<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>

<div class="card">


    <div class="card-header">
        <h5>Creer un nouvel utilisateur</h5>
    </div>

    <div class="card-body">

            <div class="row mt-3">
                <div class="col-12 col-lg-2 col-md-12 mb-3">
                    <label class="form-label">{% trans "Nom complet" %}</label>
                    <input id="user_nom" type="text" class="form-control user_field">
                </div>
                <div class="col-12 col-lg-2 col-md-12 mb-3">
                    <label class="form-label">Email <i style="color:green" id="email_valid" class="hidden fas fa-check"></i> <i id="email_non_valide" style="color:red" class="hidden fas fa-times"></i></label>
                    <input id="user_email" type="email" class="form-control user_field">
                </div>
                <div class="col-12 col-lg-3 col-md-12 mb-3">
                    <label class="form-label">{% trans "Mot de passe" %} <i style="color:green" id="password_valid" class="hidden fas fa-check"></i> <i id="password_non_valide" style="color:red" class="hidden fas fa-times"></i></label>
                    <input id="user_password" type="password" class="form-control user_field">
                </div>
                <div class="col-12 col-lg-3 col-md-12 mb-3">
                    <label class="form-label">{% trans "Confirmer le mot de passe" %} <i style="color:green" id="password2_valid" class="hidden fas fa-check"></i> <i id="password2_non_valide" style="color:red" class="hidden fas fa-times"></i></label>
                    <input id="user_password2" type="password" class="form-control user_field">
                </div>
                <div class="col-12 col-lg-1 col-md-12 mb-3">
                    <button id="save_equipe" disabled style="position:relative; top:25px;" class="btn btn-success">Confirmer</button>
                </div>
            </div>

            </div>
            </div>


            <div class="card">


                <div class="card-header">
                    <h5>Liste des utilisateurs actuels</h5>
                </div>
            
                <div class="card-body">

            <table class="table table-hover my-0">
                <thead>
                    <tr>
                        <th class="hidden"></th>
                        <th>{% trans "Nom complet" %}</th>
                        <th>Email</th>
                        <th class="text-end">{% trans "Action" %}</th>
                    </tr>
                </thead>

                <tbody id="tbody_utilstateurs">
                    {% for user in users %}
                    <tr>
                        <td class="hidden id_user">{{user.user.id}}</td>
                        <td class="table_u_nom">{{user.complete_name|default_if_none:""}}</td>
                        <td class="table_u_email">{{user.user.email|default_if_none:""}}</td>
                        {% if user.user.id != request.user.id %}
                        <td class="text-end text-danger"><button class="delete_user btn btn-sm btn-danger">Supprimer</button> <button class="manage_permissions btn btn-sm btn-success">Permissions</button></td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>


    </div>

<script>

    var user_nom = ""
    var user_email = ""
    var user_password = ""
    var user_password2 = ""
    var password_valid = false
    var password_valid2 = false
    var email_valid = false
    var id_a_modifier = ""
    
    $(document).on("keyup", ".user_field", function() {
        enable_disable_button()
    });
    
    function enable_disable_button()
    {
        if (user_nom != "" && user_email != "" && user_password != "" && password_valid == true && email_valid == true && password_valid2 == true)
        {
            $("#save_equipe").prop("disabled", false)
        }else
        {
            $("#save_equipe").prop("disabled", true)
        }
    }
    
    $(document).on("keyup", "#user_nom", function() {
        user_nom = clean_string($(this).val());
    });
    
    $(document).on("keyup", "#user_email", function() {
        user_email = clean_string($(this).val());
        console.log(validate_email(user_email))
    
    if (user_email == "")
    {
        $("#email_valid").hide();
        $("#email_non_valide").hide();
        email_valid = false
    }
    else if (validate_email(user_email))
    {
        $("#email_valid").show();
        $("#email_non_valide").hide();
        email_valid = true
    }
    else
    {
        $("#email_valid").hide();
        $("#email_non_valide").show();
        email_valid = false
    }
    
    });
    
    
    $(document).on("keyup", "#user_password2", function() {
        user_password2 = $(this).val();
        if (user_password2 == "")
        {
            $("#password2_valid").hide();
            $("#password2_non_valide").hide();
            password_valid2 = false
        }
        else if (user_password2 == user_password)
        {
            $("#password2_valid").show();
            $("#password2_non_valide").hide();
            password_valid2 = true
        }
        else
        {
            $("#password2_valid").hide();
            $("#password2_non_valide").show();
            password_valid2 = false
        }
    });
    
    
    $(document).on("keyup", "#user_password", function() {
        user_password = $(this).val();
        if (user_password == "")
        {
            $("#password_valid").hide();
            $("#password_non_valide").hide();
            password_valid = false
        }
        else if (password_strength(user_password))
        {
            $("#password_valid").show();
            $("#password_non_valide").hide();
            password_valid = true
        }
        else
        {
            $("#password_valid").hide();
            $("#password_non_valide").show();
            password_valid = false
        }
    });
    
    
    function clean_string(str)
    {
        return str.replace(/(<([^>]+)>)/ig,"")
    }
    
    
    function password_strength(pass)
    {
        return /(?=.*[A-Z])(?=.*[!@#$&])(?=.*[0-9])(?=.*[a-z]).{8}/.test(pass);
    }
    
    
    function validate_email(email)
    {
        return /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(email);
    }
    
    
    $(document).on("click", ".modifier_utilisateur", function() {
    
        id_a_modifier = $(this).closest("tr").find(".id_user").text()
        id_a_modifier = id_a_modifier.toString().replace(/\u00a0/g, "");
        id_a_modifier = id_a_modifier.replace(/\,/g,'');
        id_a_modifier = id_a_modifier.replace(/\./g,'');
    
        $("#user_nom").val($(this).closest("tr").find(".table_u_nom").text())
        $("#user_email").val($(this).closest("tr").find(".table_u_email").text())
    
        user_email = $(this).closest("tr").find(".table_u_email").text()
        user_nom = 
    
        enable_disable_button()
    
    });
    

    $(document).on("click", ".delete_user", function() {
    
        var id_to_delete = $(this).closest("tr").find(".id_user").text()
        id_to_delete = id_to_delete.toString().replace(/\u00a0/g, "");
        id_to_delete = id_to_delete.replace(/\,/g,'');
        id_to_delete = id_to_delete.replace(/\./g,'');

        Swal.fire({
        title: 'Are you sure?',
        text: "Êtes vous sûr de vouloir supprimer cet utilisateur?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Confirm',
        cancelButtonText: 'Cancel',
        }).then((result) => {
        if (result.isConfirmed) {
    
            data_dict={"action":"delete_user", "id_to_delete": id_to_delete}
            $.ajax({
                headers: { "X-CSRFToken": getCookie("csrftoken") },
                type: 'POST',
                processData: false,
                contentType: false,
                url: "{% url 'ajax_calls' %}",
                data : JSON.stringify(data_dict),
                success: function (response) {
                    Swal.fire(
                        'Deleted!',
                        'Utilisateur supprimé avec succès!',
                        'success'
                    )
                    $( ".id_user" ).each(function( index ) {
                        var id_check = $(this).closest("tr").find(".id_user").text()
                        id_check = id_check.toString().replace(/\u00a0/g, "");
                        id_check = id_check.replace(/\,/g,'');
                        id_check = id_check.replace(/\./g,'');
                        if(id_check == id_to_delete)
                        {
                            $(this).closest("tr").remove()
                        }
                    });
                }
            
            })
    
        }
        })
    
    });
    
    $(document).on("click", "#save_equipe", function() {
    
        data_dict={"action":"add_user", "id_a_modifier": id_a_modifier, "user_nom": user_nom, "user_email": user_email, "user_password": user_password}
        $.ajax({
            headers: { "X-CSRFToken": getCookie("csrftoken") },
            type: 'POST',
            processData: false,
            contentType: false,
            url: "{% url 'ajax_calls' %}",
            data : JSON.stringify(data_dict),
            success: function (response) {
                if (response["status"] == "Success")
                {
                    Swal.fire({
                    position: 'center',
                    icon: 'success',
                    title: response["message"],
                    showConfirmButton: false,
                    timer: 1500
                    })
                    
                    row_html = `
                        <tr>
                        <td class="hidden id_user">` + response["nv_id"] + `</td>
                        <td class="table_u_nom">` + user_nom + `</td>
                        <td class="table_u_email">` + user_email + `</td>
                        <td class="text-end"><button class="delete_user btn btn-sm btn-danger">Supprimer</button> <button class="manage_permissions btn btn-sm btn-success">Permissions</button></td>
                        <tr>
                    `
    
                    $("#tbody_utilstateurs").append(row_html)
    
                }
                else if (response["status"] == "Error")
                {
                    Swal.fire({
                    icon: 'error',
                    text: response["message"],
                    })
                }
    
            }
        })
        id_a_modifier = ""
    });

$(document).on('click', '.manage_permissions', function (){

var user_id = $(this).closest("tr").find(".id_user").text();
get_user_permissions(user_id);

});


function get_user_permissions(user_id)
{
    array = []
    data_dict={"action":"get_user_permissions", "user_id": user_id}
        $.ajax({
            headers: { "X-CSRFToken": getCookie("csrftoken") },
            type: 'POST',
            processData: false,
            contentType: false,
            url: "{% url 'ajax_calls' %}",
            data : JSON.stringify(data_dict),
            success: function (response) {

                html_list_permissions = response['html_return']

                Swal.fire({
                    title: "Désigner les permissions de l'utilisateur",
                    html: html_list_permissions,
                    showCancelButton: true,
                    confirmButtonText: 'Save',

                    preConfirm: () => {

                        permissions_array = []

                        $( ".permission_label_checkbox" ).each(function( index ) {
                            if($(this).is(":checked"))
                            {
                                permissions_array.push(
                                    $(this).closest(".permission_label").find(
                                        ".permission_text").text())
                            }
                        });

                        data_dict={"action":"save_user_permissions", "user_id": user_id, "permissions_array": permissions_array}
                        $.ajax({
                            headers: { "X-CSRFToken": getCookie("csrftoken") },
                            type: 'POST',
                            processData: false,
                            contentType: false,
                            url: "{% url 'ajax_calls' %}",
                            data : JSON.stringify(data_dict),
                            success: function (response) {

                            }
                        })
                    },

                    });


            }
    })

}

</script>

{% endblock %}