{% extends "base.html" %}
{% block page_content %}

{% load i18n %}
{% load static %}
{% load humanize %}



    <div class="mb-3 d-grid gap-2 d-md-flex justify-content-md-end">
        <a href="{% url 'add_contrat' %}" class="btn btn-success" type="button"><i style="margin-right:5px;" class="fas fa-plus"></i> {% trans "Ajouter contrat" %}</a>
      </div>


      <div class="row align-items-end mb-3">
        <div class="col-lg-12">
            <div class="page-header-title">
                <div class="d-inline">
                    <h4>Liste des contrats</h4>
                </div>
            </div>
        </div>
    </div>

    <div class="filter-row row mb-3">
        <div class="col-xl-12 col-md-12">
            <div class="card card-filter">
                <div class="card-body">
                    <h5 class="card-title p0p9 filter_span mb-3">{% trans 'Filtre' %}</h5>
                    <div class="row">
                        <div class="col-lg-3 col-md-4 col-sm-6 col-12 mb-3">
                            <input type="text" id="filter_numero_client" class="form-control filter_input" placeholder="{% trans 'Numéro client' %}">
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6 col-12 mb-3">
                            <input type="text" id="filter_raison_sociale" class="form-control filter_input" placeholder="{% trans 'Raison sociale' %}">
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6 col-12 mb-3">
                            <input type="text" id="filter_rue" class="form-control filter_input" placeholder="{% trans 'Rue' %}">
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6 col-12 mb-3">
                            <input type="text" id="filter_zipcode" class="form-control filter_input" placeholder="{% trans 'Zipcode' %}">
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6 col-12 mb-3">
                            <input type="text" id="filter_npa" class="form-control filter_input" placeholder="{% trans 'NPA' %}">
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6 col-12 mb-3">
                            <input type="text" id="filter_localite" class="form-control filter_input" placeholder="{% trans 'Localité' %}">
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6 col-12 mb-3">
                            <input type="text" id="filter_nom_interlocuteur" class="form-control filter_input" placeholder="{% trans 'Nom interlocuteur' %}">
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6 col-12 mb-3">
                            <input type="text" id="filter_prenom_interlocuteur" class="form-control filter_input" placeholder="{% trans 'Prénom interlocuteur' %}">
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6 col-12 mb-3">
                            <input id="filter_contrat_date" class="form-control filter_input_change" placeholder="{% trans 'Date de contrat' %}">
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6 col-12 mb-3">
                            <select id="filter_contrat_end_in" class="form-control filter_input_change">
                                <option value="">Fin de contrat dans</option>
                                <option value="30 jours">30 jours</option>
                                <option value="60 jours">60 jours</option>
                                <option value="90 jours">90 jours</option>
                                <option value="120 jours">120 jours</option>
                                <option value="180 jours">180 jours</option>
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6 col-12 mb-3">
                            <input id="filter_contrat_telephone" class="form-control filter_input" placeholder="{% trans 'Numéro de téléphone' %}">
                        </div>
                        {% if request.user.user_profile.role == "Administrateur" %}
                            <div class="col-lg-3 col-md-4 col-sm-6 col-12 mb-3">
                                <select id="filter_utilisateur" class="form-control filter_input_change">
                                    <option value="" selected>Utilisateur</option>
                                    {% for u in utilisateurs %}
                                        <option value="{{u.id|safe}}">{{u.user.username}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-xl-12 col-md-12">
        <div id="table_contrats"></div>
    </div>
    </div>
      



<script
    src="https://code.jquery.com/jquery-3.6.1.js"
    integrity="sha256-3zlB5s2uwoUzrXK3BT7AX3FyvojsraNFxCc2vC/7pNI="
    crossorigin="anonymous"></script>
  
  <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script> 
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/3.0.5/daterangepicker.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/3.0.5/daterangepicker.css" />
  

<script>



//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
///////////////////WHEN DOM IS READY//////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////

$( document ).ready(function() {
    

    // GESTION DES MESSAGES DE L'AFFICHAGE
    filter_results(0)

    });


//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
/////////////////////////////AT LOAD//////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////




var filter_page = 1
$('#filter_contrat_date').daterangepicker({
    locale: {
      format: 'DD-MM-YYYY',
      applyLabel: "Ok",
    }
})
$("#filter_contrat_date").val('');

//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
//////////////////////FILTER ACTIONS//////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////

$(document).on("change", ".filter_input_change", function() {
filter_results(0)
});

$(document).on("keyup", ".filter_input", function() {
filter_results(0)
});

$(document).on('click', '.page-link', function() {
filter_page= $(this).text();
filter_results(0)
});

$(document).on('click', '.prev-page-liste', function() {
filter_page = parseInt(filter_page) - 1
filter_results(0);
});

$(document).on('click', '.next-page-liste', function() {
filter_page = parseInt(filter_page) + 1
filter_results(0);
});


var cycle_id_modifier = 0

$(document).on('click', '.modifier_cycle_button', function (){

cycle_id = $(this).closest("tr").find(".cycle_id").text()
cycle_id_modifier = cycle_id
contrat_id = $(this).closest(".contrat_card").find(".contrat_id_span").text()
data_dict = {
    "action": "get_cycle_info",
    "cycle_id": cycle_id,
    }
    $.ajax({
    headers: {
        "X-CSRFToken": getCookie("csrftoken")
    },
    type: 'POST',
    processData: false,
    contentType: false,
    url: "{% url 'ajax_calls' %}",
    data: JSON.stringify(data_dict),
    success: function(responseCycle) {

        var html_gerer_cycle = `
        <div class="row" style="text-align: left !important;">
            <div class="col-xl-12 col-md-12">
                <div class="form-group">
                    <label class="form-label" for="date_debut">Date de début</label>
                    <input type="text" class="form-control" id="cycle_date_debut">
                </div>
                <div class="form-group">
                    <label class="form-label" for="date_fin">Date de fin</label>
                    <input type="text" class="form-control" id="cycle_date_fin">
                </div>
                <div class="form-group">
                    <input type="file" id="file-input" accept="image/*, .pdf">
                    <div style="text-align:center;">
                        <img style="display:none; height: 100px;" id="file-image" src="{% static 'assets/images/file-image.png' %}" alt="Profile Picture">
                        <p id="file_name_upload" class="mb-3" style="font-weight:600;"></p>

                        <p id="file_links" style="display:none;"><a target="_blank" class="link_file link_consulter">Consulter</a><a class="link_file link_modifier">Modifier</a><a class="link_file link_supprimer">Supprimer</a></p>
                    </div>
                </div>
            </div>
        </div>`
            var row_element = $(this).closest("tr")
            var id_task = row_element.find(".task_id").text()
            Swal.fire({
            title: 'Modifier le cycle de renouvelement',
            html: html_gerer_cycle,
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Enregistrer',
            cancelButtonText: 'Annuler'
            }).then((result) => {
            if (result.isConfirmed) {

                const fileInput = document.getElementById('file-input');
                const file = fileInput.files[0];

                var formData = new FormData();
                formData.append('file', file);
                formData.append('cycle_id', cycle_id);
                formData.append('new_date_debut', $("#cycle_date_debut").val());
                formData.append('new_date_fin', $("#cycle_date_fin").val());

                $.ajax({
                    headers: { "X-CSRFToken": getCookie("csrftoken") },
                    type: 'POST',
                    processData: false,
                    contentType: false,
                    url: "{% url 'save_cycle' %}",
                    data : formData,
                    success: function (response) {
                    Swal.fire(
                        'Modifié!',
                        'Le cycle de renouvelement est modifié avec succès',
                        'success',
                        )
                    filter_results(contrat_id)
                }
                })
            }
            })
    
            $(function() {
            $( "#cycle_date_fin" ).datepicker(
                {
                dateFormat: "dd-mm-yy"
                });
                $("#cycle_date_fin").datepicker("setDate", responseCycle['date_fin']);
            });

            $(function() {
            $( "#cycle_date_debut" ).datepicker(
                {
                dateFormat: "dd-mm-yy"
                });
                $("#cycle_date_debut").datepicker("setDate", responseCycle['date_debut']);
            });

            if (responseCycle['file_name'] != "")
            {
                $("#file-input").hide()
                $("#file-image").show()
                $("#file_links").show()
                $(".link_consulter").attr("href", `../../afficher-document/` + cycle_id)
            }

            if(responseCycle['statut'] != "En cours")
            {
                $("#cycle_date_fin").attr("disabled", true)
                $("#cycle_date_debut").attr("disabled", true)
            }

    }
    })



});

$(window).scroll(function() {
    var datePicker = $('#cycle_date_fin').datepicker();
    datePicker.datepicker('hide');
    $('#cycle_date_fin').blur();
    var datePicker2 = $('#cycle_date_debut').datepicker();
    datePicker2.datepicker('hide');
    $('#cycle_date_debut').blur();
});

$(window).resize(function() {
    var datePicker = $('#cycle_date_fin').datepicker();
    datePicker.datepicker('hide');
    $('#cycle_date_fin').blur();
    var datePicker2 = $('#cycle_date_debut').datepicker();
    datePicker2.datepicker('hide');
    $('#cycle_date_debut').blur();
});

$(document).on("click", ".supprimer_cycle_button", function() {

cycle_id = $(this).closest("tr").find(".cycle_id").text()
contrat_id = $(this).closest(".contrat_card").find(".contrat_id_span").text()

Swal.fire({
text: "Êtes vous sûr de vouloir supprimer ce cycle? Cela supprimera tous les données liées et vous ne pourrez pas revenir en arrière",
icon: 'warning',
showCancelButton: true,
confirmButtonColor: '#3085d6',
cancelButtonColor: '#d33',
confirmButtonText: 'Confirmer',
cancelButtonText: 'Annuler'
}).then((result) => {
if (result.isConfirmed) {
data_dict = {
"action": "supprimer_cycle_payment",
"cycle_id": cycle_id,
}
$.ajax({
headers: {
    "X-CSRFToken": getCookie("csrftoken")
},
type: 'POST',
processData: false,
contentType: false,
url: "{% url 'ajax_calls' %}",
data: JSON.stringify(data_dict),
success: function(response) {
    if (response['errors'] != "0")
    {
        Swal.fire({
            icon: 'error',
            title: 'Une erreur est survenue!',
            position: 'center',
            showConfirmButton: false,
            text: response['error_message'],
        })
    }else
    {
        Swal.fire({
            icon: 'success',
            title: "Cycle supprimé avec succés",
            showConfirmButton: false,
            timer: 1500
        })
        filter_results(contrat_id)
    }
}
})

}
})


});


$(document).on("click", ".payer_cycle_button", function() {

cycle_id = $(this).closest("tr").find(".cycle_id").text()
contrat_id = $(this).closest(".contrat_card").find(".contrat_id_span").text()

Swal.fire({
text: "Êtes vous sûr de vouloir marquer ce cycle comme payé? Cela créera un nouveau cycle avec la durée attribué pour le contrat et vous ne pourrez pas revenir en arrière",
icon: 'question',
showCancelButton: true,
confirmButtonColor: '#3085d6',
cancelButtonColor: '#d33',
confirmButtonText: 'Confirmer',
cancelButtonText: 'Annuler'
}).then((result) => {
if (result.isConfirmed) {
    data_dict = {
    "action": "marquer_cycle_comme_paye",
    "cycle_id": cycle_id,
    }
    $.ajax({
    headers: {
        "X-CSRFToken": getCookie("csrftoken")
    },
    type: 'POST',
    processData: false,
    contentType: false,
    url: "{% url 'ajax_calls' %}",
    data: JSON.stringify(data_dict),
    success: function(response) {
        if (response['errors'] != "0")
        {
            Swal.fire({
                icon: 'error',
                title: 'Une erreur est survenue!',
                position: 'center',
                showConfirmButton: false,
                text: response['error_message'],
            })
        }else
        {
            Swal.fire({
                icon: 'success',
                title: "Cycle marqué comme payé avec succés",
                showConfirmButton: false,
                timer: 1500
            })
            filter_results(contrat_id)
        }
    }
    })

}
})


});

$(document).on('click', '.link_modifier', function() {
    document.getElementById('file-input').click();
});

$(document).on('click', '.link_supprimer', function() {

data_dict = {
    "action": "delete_file",
    "cycle_id": cycle_id_modifier,
    }
    $.ajax({
    headers: {
        "X-CSRFToken": getCookie("csrftoken")
    },
    type: 'POST',
    processData: false,
    contentType: false,
    url: "{% url 'ajax_calls' %}",
    data: JSON.stringify(data_dict),
    success: function(response) {
        document.getElementById('file-input').input = '';
        $("#file_name_upload").html("")
        $("#file-image").hide("")
        $("#file_links").hide("")
        $("#file-input").show("")
    }
    })


});

$(document).on('change', '#file-input', function(event) {
  const fileInput = event.target;
    const profilePicture = document.getElementById('file_name_upload');
  if (fileInput.files && fileInput.files[0]) {
    const reader = new FileReader();
    profilePicture.innerHTML = `${fileInput.files[0].name}`;
    reader.onload = function(e) {
      $("#file-image").show("")
      $("#file_links").show("")
      $("#file-input").hide("")
    };

    reader.readAsDataURL(fileInput.files[0]);




  }
});

$(document).on("click", ".delete-contrat-btn", function() {

contrat_id = $(this).closest(".contrat_card").find(".contrat_id_span").text()
table_line = $(this).closest(".contrat_card")
Swal.fire({
title: 'Attention',
text: "Voulez-vous vraiment supprimer ce contrat ? Cela supprimera par conséquent toutes les informations associées et vous ne pourrez pas revenir en arrière",
icon: 'warning',
showCancelButton: true,
confirmButtonColor: '#3085d6',
cancelButtonColor: '#d33',
confirmButtonText: 'Confirmer',
cancelButtonText: 'Annuler'
}).then((result) => {
if (result.isConfirmed) {
    data_dict = {
    "action": "delete_contrat",
    "contrat_id": contrat_id,
    }
    $.ajax({
    headers: {
        "X-CSRFToken": getCookie("csrftoken")
    },
    type: 'POST',
    processData: false,
    contentType: false,
    url: "{% url 'ajax_calls' %}",
    data: JSON.stringify(data_dict),
    success: function(response) {
        if (response['error'] != "0")
        {
            Swal.fire({
                icon: 'error',
                title: 'Une erreur est survenue!',
                position: 'center',
                showConfirmButton: false,
                text: response['error_text'],
            })
        }else
        {
            Swal.fire({
                icon: 'success',
                title: "Contrat supprimée avec succés",
                showConfirmButton: false,
                timer: 1500
            })
            table_line.remove()
        }
    }
    })

}
})

});

//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
///////////////////DECLARING FUNCTIONS///////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////

    function filter_results(contrat_to_expand)
    {
        var data_dict = {
        "action": "filter_contrats_list",
        "numero_client": $("#filter_numero_client").val(),
        "raison_sociale": $("#filter_raison_sociale").val(),
        "filter_contrat_telephone": $("#filter_contrat_telephone").val(),
        "rue": $("#filter_rue").val(),
        "filter_contrat_end_in": $("#filter_contrat_end_in").val(),
        "zipcode": $("#filter_zipcode").val(),
        "npa": $("#filter_npa").val(),
        "localite": $("#filter_localite").val(),
        "nom_interlocuteur": $("#filter_nom_interlocuteur").val(),
        "prenom_interlocuteur": $("#filter_prenom_interlocuteur").val(),
        "date_contrat": $("#filter_contrat_date").val(),
        "utilisateur": $("#filter_utilisateur").val(),
        "page": filter_page
    };

    $.ajax({
        headers: {
            "X-CSRFToken": getCookie("csrftoken")
        },
        type: 'POST',
        processData: false,
        contentType: false,
        url: "{% url 'ajax_calls' %}",
        data: JSON.stringify(data_dict),
        success: function(response) {
            $("#table_contrats").html(response["html"])
            if(contrat_to_expand > 0)
            {
                $( ".contrat_card" ).each(function( index ) {
                    if ($(this).find(".contrat_id_span").text() == contrat_to_expand)
                    {
                        $(this).find(".accordion-msg").click()
                        $(this).find(".renouvelements_button").click()
                    }
                });
            }
        }
    })
}

</script>

<style>

.link_file
{
    margin-right: 5px;
    margin-left: 5px;
    cursor:pointer;
}
.link_file:hover
{
    color:blue !important;
}

</style>

{% endblock %}